<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{ /fragment/header :: header }"></div>
<!-- header replace -->

<!-- 바디 시작 -->
<body>
<div class="container">
    <input type="hidden" th:object="${user}" th:field="*{mid}">
    <br><br><h4><span th:text="|${ user.getName() }님 환영합니다|"/></h4><br><br>
    <h3><span th:text="${ message }"/></h3><br>
    <h2><span th:text="${ month }" />월</h2> <br>
    <p>총 수입: +<span th:text="|${ #numbers.formatInteger(incomeSum, 3, 'COMMA') }|" />원</p>
    <p>총 지출: -<span th:text="|${ #numbers.formatInteger(expenseSum, 3, 'COMMA') }|" />원</p>
    <p>총 합계: <span th:text="|${ #numbers.formatInteger(restSum, 3, 'COMMA') }|" />원</p>
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Income</th>
                <th>Expense</th>
                <th>Sum</th>
                <th>Rest</th>
            </tr>
        </thead>
        <tbody>
        <tr th:each="day: ${ #numbers.sequence(1, days) }">
                <td th:text="|${ dayStat.count }일|"></td>
                <td>john@example.com</td>
                <td>john@example.com</td>
                <td>john@example.com</td>
                <td>john@example.com</td>
                <td style="border-top-style: hidden"><button type="button" class="btn btn-dark" name="input-btn" id="input-btn" value="수입 등록" th:onclick="'javascript:index.openIncome(this);'" data-toggle="modal" data-target="#incomeModal" th:data-day="${ dayStat.count }"></button></td>
                <td style="border-top-style: hidden"><button type="button" class="btn btn-dark" name="expense-btn" id="expense-btn" value="지출 등록" th:onclick="'javascript:index.openExpense(this);'" data-toggle="modal" data-target="#expenseModal" th:data-day="${ dayStat.count }"></button></td>
            </tr>
        </tbody>
    </table>
</div>
</body>
<!-- 바디 끝 -->

<!-- 수입 등록 모달 섹션 시작 -->
<div class="modal fade" id="incomeModal" th:object="${income}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">수입 등록</h2>
            </div>
            <div class="modal-body">
                <input type="text" th:name="income-date" th:id="income-date">
                <label for="incomeMoney">금액</label>
                <input type="text" th:name="incomeMoney" th:id="incomeMoney" class="form-control" placeholder="금액을 입력해주세요"/>
                <label for="incomeReason">명목</label>
                <input type="text" th:field="*{incomeReason}" class="form-control" placeholder="명목을 입력해주세요"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="income-save">등록</button>
                <button type="button" class="btn btn-light" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<!-- 수입 등록 모달 섹션 끝 -->

<!-- 지출 등록 모달 섹션 시작 -->
<div class="modal fade" id="expenseModal" th:object="${expense}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">지출 등록</h2>
            </div>
            <div class="modal-body">
                <input type="text" th:name="expense-date" th:id="expense-date">
                <label for="expenseMoney">금액</label>
                <input type="text" th:name="expenseMoney" th:id="expenseMoney" class="form-control" placeholder="금액을 입력해주세요"/>
                <label for="expenseReason">명목</label>
                <input type="text" th:field="*{expenseReason}" class="form-control" placeholder="명목을 입력해주세요"/>
                <label for="expenseCategory">분류</label>
                <select th:field="*{expenseCategory}" class="selectpicker">
                    <option th:value="0">==카테고리==</option>
                    <option th:value="GROCERY">식료품</option>
                    <option th:value="EAT_OUT">외식</option>
                    <option th:value="DELIVERY">배달</option>
                    <option th:value="HOUSEWARES">생필품</option>
                    <option th:value="ACTIVITY">여가활동</option>
                    <option th:value="CLOTHES">의류</option>
                    <option th:value="HEALTH">병원/약국비</option>
                    <option th:value="PHONE">휴대폰요금</option>
                    <option th:value="TRANSPORTATION">교통비</option>
                    <option th:value="DEPOSIT">예/적금</option>
                    <option th:value="INSURANCE">보험료</option>
                    <option th:value="RENT">집세</option>
                    <option th:value="UTILITIES">공과금</option>
                    <option th:value="REPAYMENT">대출상환금</option>
                    <option th:value="TRIBUTE">경조사비</option>
                    <option th:value="ETC">기타</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="expense-save">등록</button>
                <button type="button" class="btn btn-light" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<!-- 지출 등록 모달 섹션 끝 -->

<!-- 자바스크립트 시작 -->
<script type="text/javascript">
    let index = {

        // 수입 모달 오픈 시 해당 날짜 전달
        openIncome: function (btn) {
            let year = [[${ year }]];
            let month = [[${ month }]].toString();
            let day = $(btn).data('day').toString();

            if (month.length === 1) {
                month = 0 + month;
            }
            if (day.length === 1) {
                day = 0 + day;
            }

            $("#income-date").val(year+''+month+''+day);
        },

        // 지출 모달 오픈 시 해당 날짜 전달
        openExpense: function (btn) {
            let year = [[${ year }]];
            let month = [[${ month }]].toString();
            let day = $(btn).data('day').toString();

            if (month.length === 1) {
                month = 0 + month;
            }
            if (day.length === 1) {
                day = 0 + day;
            }

            $("#expense-date").val(year+''+month+''+day);
        }
    }

    // 수입 작성
    $("#income-save").click(function () {
        let data = {
            mid: $("#mid").val(),
            incomeMoney: $("#incomeMoney").val(),
            incomeReason: $("#incomeReason").val(),
            date: $("#income-date").val()
        }
        console.log("data = ", data);

        if (data.incomeMoney.trim() === "") {
            alert('금액을 입력해주세요');
            return false;
        } else if (data.incomeReason.trim() === "") {
            alert('명목을 입력해주세요');
            return false;
        } else {
            $.ajax({
                type: "post",
                url: "/api/accountBook/writeIncome",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8"
            }).done(function (response) {
                alert('등록이 완료되었습니다');
                window.location.reload();
            }).fail(function (error) {
                console.log("error = ", error);
                alert('서버 장애로 인해 오류가 발생했습니다 \n 다시 시도해주세요');
            });
        }
    });

    // 지출 작성
    $("#expense-save").click(function () {
        let data = {
            mid: $("#mid").val(),
            expenseMoney: $("#expenseMoney").val(),
            expenseReason: $("#expenseReason").val(),
            expenseCategory: $("#expenseCategory").val(),
            date: $("#expense-date").val()
        }
        console.log("data = ", data);

        if (data.expenseMoney.trim() === "") {
            alert('금액을 입력해주세요');
            return false;
        } else if (data.expenseReason.trim() === "") {
            alert('명목을 입력해주세요');
            return false;
        } else if (data.expenseCategory === "0") {
            alert('분류을 선택해주세요');
            return false;
        } else {
            $.ajax({
                type: "post",
                url: "api/accountBook/writeExpense",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8"
            }).done(function (response) {
                alert('등록이 완료되었습니다');
                window.location.reload();
            }).fail(function (error) {
                console.log("error = ", error);
                alert('서버 장애로 인해 오류가 발생했습니다 \n 다시 시도해주세요');
            });
        }
    });

    index.init();
</script>
<!-- 자바스크립트 끝 -->

</html>
